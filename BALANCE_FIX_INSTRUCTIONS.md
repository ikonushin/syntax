# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ —Å—á—ë—Ç–æ–≤

## –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### Backend (`/backend/routes/accounts.py`)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –Ω–æ–≤—ã–π endpoint: `GET /v1/accounts/{account_id}/balances`
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ –±–∞–Ω–∫–∞ - —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –±–∞–∑–æ–≤—ã–π `client_id` (team286) –≤–º–µ—Å—Ç–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ (team286-9)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö —Ç—Ä—ë—Ö –±–∞–Ω–∫–æ–≤ (ABank, SBank, VBank)
- ‚úÖ –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞

### Frontend (`/frontend/src/pages/TaxPaymentsPage.jsx`)
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –∏–∑ –æ—Ç–≤–µ—Ç–∞
- ‚úÖ –£–ª—É—á—à–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `formatAmount()` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ–±—ä–µ–∫—Ç–∞–º–∏ balance
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫

## –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### –®–∞–≥ 1: –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –±—Ä–∞—É–∑–µ—Ä
```
http://localhost:5173/tax-payments
```

### –®–∞–≥ 2: –û—Ç–∫—Ä—ã—Ç—å Developer Tools (F12)
**Console** tab

### –®–∞–≥ 3: –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏

**–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ª–æ–≥–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å:**
```
üìä TaxPayments: Loading accounts with selectedUserIndex=9, selectedBank=abank
üìä TaxPayments: Computed userId=team286-9
‚úÖ TRANSACTIONS: Found 1 active consents
üí∞ TaxPayments: Fetching balance for account acc-3959...
‚úÖ TaxPayments: Balance loaded: 4447.00 RUB
```

**–ò–ª–∏ –µ—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∞:**
```
‚ùå TaxPayments: Failed to load balance for account acc-3959: {
  "message": "Error message",
  "response": {...},
  "status": 401|403|404|503
}
```

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Backend –ª–æ–≥–∏
```bash
docker-compose logs backend --tail=50 | grep -i balance
```

**–û–∂–∏–¥–∞–µ–º—ã–µ –ª–æ–≥–∏ (–Ω–æ–≤—ã–µ):**
```
üîç BALANCES: Getting bank-specific token for abank
üîç BALANCES: Using base_client_id=team286 for bank token
üí∞ BALANCES: GET https://abank.open.bankingapi.ru/accounts/acc-3959/balances
üí∞ BALANCES: Response status: 200
‚úÖ BALANCES: Got 1 balance(s) for account acc-3959
```

### –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
–ë–∞–ª–∞–Ω—Å –¥–æ–ª–∂–µ–Ω –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤–º–µ—Å—Ç–æ "0,00 ‚ÇΩ" –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ Tax Payments:
```
–°—á–µ—Ç: acc-3959
–ë–∞–ª–∞–Ω—Å: 4 447,00 ‚ÇΩ ‚Üê –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–µ–∞–ª—å–Ω–∞—è —Å—É–º–º–∞
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ API endpoint

### Request
```
GET /v1/accounts/{account_id}/balances

Headers:
  Authorization: Bearer {jwt_token}
  consent_id: {consent_id}
  X-Bank-Name: abank|sbank|vbank
  client_id: team286-9
```

### Response (200 OK)
```json
{
  "balance": {
    "amount": 4447.00,
    "currency": "RUB",
    "type": "Available"
  },
  "balances": [
    {
      "amount": 4447.00,
      "currency": "RUB",
      "type": "Available"
    }
  ]
}
```

### Error Responses
```
401 Unauthorized - –ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω
403 Forbidden - –°–æ–≥–ª–∞—Å–∏–µ –æ—Ç–æ–∑–≤–∞–Ω–æ
404 Not Found - Account –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç  
503 Service Unavailable - –ë–∞–Ω–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
500 Internal Server Error - –û—à–∏–±–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
```

## –ï—Å–ª–∏ –±–∞–ª–∞–Ω—Å –≤—Å—ë –µ—â—ë –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç 0

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ backend:**
   ```bash
   docker-compose logs backend --tail=100 | grep -E "(BALANCES|error|401|403)"
   ```

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ consent –∞–∫—Ç–∏–≤–Ω—ã–π:**
   ```bash
   curl http://localhost:8000/api/user-consents?user_id=team286-9
   ```
   –î–æ–ª–∂–Ω—ã –±—ã—Ç—å consents —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `approved` –∏–ª–∏ `authorized`

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ accountId:**
   ```bash
   curl http://localhost:8000/v1/accounts \
     -H "Authorization: Bearer YOUR_JWT" \
     -H "consent_id: YOUR_CONSENT_ID" \
     -H "X-Bank-Name: abank" \
     -H "client_id: team286-9"
   ```

4. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ endpoint –±–∞–ª–∞–Ω—Å–∞ –Ω–∞–ø—Ä—è–º—É—é:**
   ```bash
   curl http://localhost:8000/v1/accounts/acc-3959/balances \
     -H "Authorization: Bearer YOUR_JWT" \
     -H "consent_id: YOUR_CONSENT_ID" \
     -H "X-Bank-Name: abank" \
     -H "client_id: team286-9" \
     -v
   ```

## –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

### –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –±–∞–∑–æ–≤–æ–≥–æ client_id
–ö–æ–¥ —Ç–µ–ø–µ—Ä—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ:
- `team286-9` ‚Üí `team286` (–¥–ª—è —Ç–æ–∫–µ–Ω–∞ –±–∞–Ω–∫–∞)
- `team286` ‚Üí `team286` (—É–∂–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ)

### –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ –±–∞–ª–∞–Ω—Å–∞
Endpoint –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Ä–∞–∑–Ω—ã—Ö –±–∞–Ω–∫–æ–≤:
- `{balance: {...}}` - –æ–±—ä–µ–∫—Ç –±–∞–ª–∞–Ω—Å–∞
- `{balances: [...]}` - –º–∞—Å—Å–∏–≤ –±–∞–ª–∞–Ω—Å–æ–≤
- `[...]` - –ø—Ä—è–º–æ–π –º–∞—Å—Å–∏–≤

–í—Å–µ —Ñ–æ—Ä–º–∞—Ç—ã –Ω–æ—Ä–º–∞–ª–∏–∑—É—é—Ç—Å—è –≤ `{balance: {...}, balances: [...]}`

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–ï—Å–ª–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:
1. ‚úÖ –ë–∞–ª–∞–Ω—Å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
2. ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ –≤ –∫–æ–Ω—Å–æ–ª–∏
3. ‚úÖ Backend –ª–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —É—Å–ø–µ—à–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã

–ú–æ–∂–Ω–æ:
- –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞—Ç–µ–∂–∏
- –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ –¥—Ä—É–≥–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥—Ä—É–≥–∏–µ –±–∞–Ω–∫–∏ (SBank, VBank)

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ß—Ç–æ –±—ã–ª–æ –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–±–ª–µ–º–æ–π
```python
# –°—Ç–∞—Ä—ã–π –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–æ–¥
bank_token = await authenticate_with_bank(
    client_id=client_id,  # ‚Üê team286-9 (–ù–ï–í–ï–†–ù–û –¥–ª—è –±–∞–Ω–∫–∞!)
    client_secret=secret,
    bank_id="abank"
)
# –†–µ–∑—É–ª—å—Ç–∞—Ç: 401 Unauthorized

# –ù–æ–≤—ã–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–æ–¥
base_client_id = "team286"  # ‚Üê –ò–∑–≤–ª–µ–∫–ª–∏ –±–∞–∑–æ–≤—ã–π ID
bank_token = await authenticate_with_bank(
    client_id=base_client_id,  # ‚Üê team286 (–í–ï–†–ù–û!)
    client_secret=secret,
    bank_id="abank"
)
# –†–µ–∑—É–ª—å—Ç–∞—Ç: 200 OK, –ø–æ–ª—É—á–∞–µ—Ç—Å—è –≤–∞–ª–∏–¥–Ω—ã–π —Ç–æ–∫–µ–Ω
```

### –ü–æ—á–µ–º—É —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç
- –ë–∞–Ω–∫–∏ (ABank, SBank, VBank) –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã —Å `client_id=team286`
- –°—É—Ñ—Ñ–∏–∫—Å `-9` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –Ω–∞—à–µ–π —Å–∏—Å—Ç–µ–º–µ
- –ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ —Ç–æ–∫–µ–Ω–∞ —É –±–∞–Ω–∫–∞ –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π `client_id`
- –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π `client_id` –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö –∑–∞–ø—Ä–æ—Å–∞
