# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° endpoint Ð±Ð°Ð»Ð°Ð½ÑÐ° ÑÑ‡Ñ‘Ñ‚Ð¾Ð²

## ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð°
ÐŸÑ€Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹ Tax Payments Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶Ð°ÐµÑ‚ÑÑ Ð±Ð°Ð»Ð°Ð½Ñ 0 â‚½, Ñ…Ð¾Ñ‚Ñ Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð²Ñ‹Ð²Ð¾Ð´Ð¸Ñ‚ÑŒÑÑ Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ð±Ð°Ð»Ð°Ð½ÑÑ‹.

## Ð ÐµÑˆÐµÐ½Ð¸Ðµ
Ð‘Ñ‹Ð» Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½ Ð½Ð¾Ð²Ñ‹Ð¹ endpoint Ð½Ð° backend Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð±Ð°Ð»Ð°Ð½ÑÐ° ÑÑ‡Ñ‘Ñ‚Ð¾Ð².

### Ð§Ñ‚Ð¾ Ð±Ñ‹Ð»Ð¾ ÑÐ´ÐµÐ»Ð°Ð½Ð¾:

#### Backend (New Endpoint)
**Ð¤Ð°Ð¹Ð»:** `/backend/routes/accounts.py`

Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½ Ð½Ð¾Ð²Ñ‹Ð¹ endpoint:
```
GET /v1/accounts/{account_id}/balances
```

**Headers:**
- `Authorization: Bearer {bank_token}` - JWT Ñ‚Ð¾ÐºÐµÐ½
- `consent_id` - ID ÑÐ¾Ð³Ð»Ð°ÑÐ¸Ñ
- `X-Bank-Name` - ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð±Ð°Ð½ÐºÐ° (abank, sbank, vbank)
- `client_id` - ID ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð° (Ð½Ð°Ð¿Ñ€. team286-9)

**Response:**
```json
{
  "balance": {
    "amount": 1500.00,
    "currency": "RUB"
  },
  "balances": [...]
}
```

#### Frontend (Improved Balance Parsing)
**Ð¤Ð°Ð¹Ð»:** `/frontend/src/pages/TaxPaymentsPage.jsx`

1. Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð° Ð»Ð¾Ð³Ð¸ÐºÐ° Ð¸Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ñ Ð±Ð°Ð»Ð°Ð½ÑÐ°:
   - Ð Ð°Ð½ÑŒÑˆÐµ: Ð¿Ñ‹Ñ‚Ð°Ð»ÑÑ Ð²Ð·ÑÑ‚ÑŒ `length` Ð¸Ð· Ð¾Ð±ÑŠÐµÐºÑ‚Ð°
   - Ð¢ÐµÐ¿ÐµÑ€ÑŒ: Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾ Ð¾Ð±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ Ð¾Ð±Ð° Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð° (`balance` Ð¾Ð±ÑŠÐµÐºÑ‚ Ð¸ `balances` Ð¼Ð°ÑÑÐ¸Ð²)

2. Ð£Ð»ÑƒÑ‡ÑˆÐµÐ½Ð° Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ `formatAmount()`:
   - Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÑ‚ Ð¾Ð±ÑŠÐµÐºÑ‚Ñ‹ Ñ Ð¿Ð¾Ð»ÐµÐ¼ `amount`
   - ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ Ñ€Ð°Ð·Ð½Ñ‹Ðµ Ð¸Ð¼ÐµÐ½Ð° Ð¿Ð¾Ð»ÐµÐ¹: `amount`, `balanceAmount`

3. Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¾ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ:
   - Ð›Ð¾Ð³Ð¸Ñ€ÑƒÐµÑ‚ Ð¿Ð¾Ð»Ð½Ñ‹Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚ ÑÐµÑ€Ð²ÐµÑ€Ð°
   - ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ Ð¸ Ð´ÐµÑ‚Ð°Ð»Ð¸

## ÐšÐ°Ðº Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ

### 1. ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€ Developer Tools (F12)
**Console** tab

### 2. ÐŸÐµÑ€ÐµÐ¹Ð´Ð¸Ñ‚Ðµ Ð½Ð° ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñƒ Tax Payments
```
http://localhost:5173/tax-payments
```

### 3. ÐŸÐ¾ÑÐ¼Ð¾Ñ‚Ñ€Ð¸Ñ‚Ðµ Ð½Ð° Ð»Ð¾Ð³Ð¸ Ð² ÐºÐ¾Ð½ÑÐ¾Ð»Ð¸
Ð”Ð¾Ð»Ð¶Ð½Ñ‹ Ð¿Ð¾ÑÐ²Ð¸Ñ‚ÑŒÑÑ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ:
```
ðŸ“Š TaxPayments: Loading accounts with selectedUserIndex=9, selectedBank=abank
ðŸ“Š TaxPayments: Fetching consents for team286-9...
âœ… TaxPayments: Found X consents
ðŸ’° TaxPayments: Fetching balance for account {accountId}...
âœ… TaxPayments: Balance loaded: 4447.00 RUB
```

### 4. Ð•ÑÐ»Ð¸ Ð²Ð¸Ð´Ð¸Ñ‚Ðµ Ð¾ÑˆÐ¸Ð±ÐºÐ¸
```
âŒ TaxPayments: Failed to load balance for account 123:
{
  "message": "Failed to fetch",
  "response": {...},
  "status": 503
}
```

Ð­Ñ‚Ð¾ Ð¾Ð·Ð½Ð°Ñ‡Ð°ÐµÑ‚, Ñ‡Ñ‚Ð¾ endpoint Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚, Ð½Ð¾ ÐµÑÑ‚ÑŒ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ð° Ñ Ð´Ð°Ð½Ð½Ñ‹Ð¼Ð¸ Ð¾Ñ‚ Ð±Ð°Ð½ÐºÐ°.

## Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ curl

### ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ñ‚Ð¾ÐºÐµÐ½ Ð¸ ÑÐ¾Ð³Ð»Ð°ÑÐ¸Ðµ (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ)
```bash
# ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÑÐ¿Ð¸ÑÐ¾Ðº ÑÐ¾Ð³Ð»Ð°ÑÐ¸Ð¹
curl -X GET "http://localhost:8000/api/user-consents" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -G --data-urlencode "user_id=team286-9" \
  --data-urlencode "access_token=YOUR_ACCESS_TOKEN"
```

### ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð±Ð°Ð»Ð°Ð½Ñ ÑÑ‡Ñ‘Ñ‚Ð°
```bash
curl -X GET "http://localhost:8000/v1/accounts/123456/balances" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "consent_id: YOUR_CONSENT_ID" \
  -H "X-Bank-Name: abank" \
  -H "client_id: team286-9"
```

## Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ñ‹Ðµ Ð¾ÑˆÐ¸Ð±ÐºÐ¸

| ÐžÑˆÐ¸Ð±ÐºÐ° | ÐŸÑ€Ð¸Ñ‡Ð¸Ð½Ð° | Ð ÐµÑˆÐµÐ½Ð¸Ðµ |
|--------|--------|--------|
| 401 Unauthorized | ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ‚Ð¾ÐºÐµÐ½ | ÐŸÐµÑ€ÐµÐ°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·ÑƒÐ¹Ñ‚ÐµÑÑŒ |
| 403 Forbidden | Ð¡Ð¾Ð³Ð»Ð°ÑÐ¸Ðµ Ð½Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ | ÐŸÐµÑ€ÐµÐ¿Ð¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚Ðµ Ð±Ð°Ð½Ðº |
| 404 Not Found | Account ID Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ | ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ ID ÑÑ‡Ñ‘Ñ‚Ð° |
| 503 Service Unavailable | Ð‘Ð°Ð½Ðº Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ | ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ |

## Logs Ð´Ð»Ñ Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ¸

Ð’ÑÐµ Ð»Ð¾Ð³Ð¸ Ð²Ñ‹Ð²Ð¾Ð´ÑÑ‚ÑÑ Ñ Ð¿Ñ€ÐµÑ„Ð¸ÐºÑÐ¾Ð¼:
- `ðŸ’°` - Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ñ Ð±Ð°Ð»Ð°Ð½ÑÐ¾Ð¼
- `âœ…` - ÑƒÑÐ¿ÐµÑˆÐ½Ñ‹Ðµ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸
- `âŒ` - Ð¾ÑˆÐ¸Ð±ÐºÐ¸
- `âš ï¸` - Ð¿Ñ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ñ
- `ðŸ“Š` - Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ

Ð›Ð¾Ð³Ð¸ ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‚:
- ÐÐ¾Ð¼ÐµÑ€ ÑÑ‡Ñ‘Ñ‚Ð°
- ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð±Ð°Ð½ÐºÐ°
- URL Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°
- Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð¾Ñ‚Ð²ÐµÑ‚Ð°
- Ð”ÐµÑ‚Ð°Ð»Ð¸ Ð±Ð°Ð»Ð°Ð½ÑÐ°

## Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ

### TaxPaymentsPage.jsx
- Ð£Ð»ÑƒÑ‡ÑˆÐµÐ½Ð° Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ñ€Ð°Ð·Ð»Ð¸Ñ‡Ð½Ñ‹Ñ… Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¾Ð² Ð¾Ñ‚Ð²ÐµÑ‚Ð° Ð¾Ñ‚ Ð±Ð°Ð½ÐºÐ¾Ð²
- Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð° Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° Ñ€Ð°Ð·Ð½Ñ‹Ñ… Ð¸Ð¼Ñ‘Ð½ Ð¿Ð¾Ð»ÐµÐ¹ (amount, balanceAmount)
- Ð£Ð»ÑƒÑ‡ÑˆÐµÐ½Ð¾ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¾ÑˆÐ¸Ð±Ð¾Ðº Ð´Ð»Ñ Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ¸

### accounts.py (Backend)
- Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½ Ð¿Ð¾Ð»Ð½Ñ‹Ð¹ endpoint Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð±Ð°Ð»Ð°Ð½ÑÐ°
- ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð°Ð½Ñ‹ Ð²ÑÐµ Ñ‚Ñ€Ð¸ Ð±Ð°Ð½ÐºÐ° (ABank, SBank, VBank)
- ÐÐ¾Ñ€Ð¼Ð°Ð»Ð¸Ð·Ð¾Ð²Ð°Ð½Ð° ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð¾Ñ‚Ð²ÐµÑ‚Ð°
- Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¾ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð²ÑÐµÑ… Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹

## Ð§Ñ‚Ð¾ Ð´Ð°Ð»ÑŒÑˆÐµ

Ð•ÑÐ»Ð¸ Ð±Ð°Ð»Ð°Ð½Ñ Ð¿Ð¾-Ð¿Ñ€ÐµÐ¶Ð½ÐµÐ¼Ñƒ Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚ 0:
1. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ, Ñ‡Ñ‚Ð¾ Ð² Ð»Ð¾Ð³Ð°Ñ… ÐµÑÑ‚ÑŒ ÑƒÑÐ¿ÐµÑˆÐ½Ñ‹Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚ Ð¾Ñ‚ /v1/accounts/{id}/balances
2. ÐŸÐ¾ÑÐ¼Ð¾Ñ‚Ñ€Ð¸Ñ‚Ðµ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ Ð¾Ñ‚Ð²ÐµÑ‚Ð° (Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð´Ñ€ÑƒÐ³Ð¾Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ð¾Ñ‚ Ð±Ð°Ð½ÐºÐ°)
3. Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ ÐºÐ¾Ð½ÑÐ¾Ð»ÑŒ-Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð² Ð»Ð¾Ð³ Ð½Ð° backend: `tail -f backend.log`
4. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ, Ñ‡Ñ‚Ð¾ balance Ð½Ðµ null Ð² localStorage (DevTools -> Application -> localStorage)
